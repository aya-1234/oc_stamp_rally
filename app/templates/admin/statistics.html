<!-- templates/admin/statistics.html -->
<!DOCTYPE html>
<html>
<head>
    <title>スタンプラリー統計情報</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-section {
            margin-bottom: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .total-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
        }
        .back-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- リロードステータス表示を修正 -->
    <div id="reload-status">
        <div class="reload-content">
            <!-- 新しい左側のナビゲーション部分 -->
            <div class="navigation-button">
                <a href="/{{ admin_hash }}" class="nav-button">管理画面に戻る</a>
            </div>
    
            <!-- 中央のカウントダウン -->
            <div class="countdown-display">
                次回更新まで: <span id="countdown">30</span>秒
            </div>
    
            <!-- 右側の更新コントロール -->
            <div class="update-controls">
                <button id="reload-toggle" class="control-button">自動更新を停止</button>
                <button onclick="forceReload()" class="force-button">今すぐ更新</button>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <h1>スタンプラリー統計情報</h1>

        <!-- 全体の統計 -->
        <div class="total-stats">
            <div class="stat-card">
                <div class="stat-label">総スタンプ取得数</div>
                <div class="stat-number">{{ total_stats.total_stamps }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">参加者数</div>
                <div class="stat-number">{{ total_stats.total_users }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">完走者数</div>
                <div class="stat-number">{{ total_stats.completion_count }}</div>
            </div>
        </div>

    <!-- templates/admin/statistics.html の関連部分を更新 -->
    <!-- ユーザー検索フォーム -->
    <div class="search-form">
        <form method="GET" action="/{{ admin_hash }}/statistics">
            <input type="text" 
                name="search" 
                value="{{ search_query }}" 
                placeholder="ユーザー名で検索..."
                class="search-input">
            <button type="submit" class="search-button">検索</button>
        </form>
    </div>

    <!-- ユーザー別取得状況 -->
    <div class="stats-section">
        <h2>ユーザー別取得状況</h2>
        
        <div class="filter-section">
            <form action="{{ url_for('stamp_statistics') }}" method="get">
                <!-- 検索ボックス -->
                <input type="text" name="search" placeholder="ユーザー検索" value="{{ search_query }}">
    
                <!-- スタンプ数のフィルター -->
                <select name="stats_filter" class="stats-filter">
                    <option value="has_stamps" {% if stats_filter == 'has_stamps' %}selected{% endif %}>スタンプ1-7個</option>
                    {% for i in range(1, 8) %}
                        <option value="stamps_{{ i }}" {% if stats_filter == 'stamps_' ~ i %}selected{% endif %}>
                            スタンプ{{ i }}個
                        </option>
                    {% endfor %}
                    <option value="stamps_1_to_2" {% if stats_filter == 'stamps_1_to_2' %}selected{% endif %}>
                        スタンプ1-2個
                    </option>
                    <option value="completed_users" {% if stats_filter == 'completed_users' %}selected{% endif %}>
                        完走者（スタンプ8個）
                    </option>
                </select>
    
                <!-- ソート順のフィルター -->
                <select name="sort_order" class="sort-filter">
                    <option value="latest_first" {% if sort_order == 'latest_first' %}selected{% endif %}>
                        新規取得順
                    </option>
                    <option value="oldest_first" {% if sort_order == 'oldest_first' %}selected{% endif %}>
                        古い順
                    </option>
                </select>
    
                <button type="submit" class="filter-button">フィルター</button>
            </form>
        </div>
    </div>
     
        <table>
            <thead>
                <tr>
                    <th>アカウント</th>
                    <th>取得スタンプ数</th>
                    <th>開始時刻</th>
                    <th>最終取得時刻</th>
                    <th>所要時間</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in users_pagination.items %}
                <tr>
                    <td>{{ stat.account }}</td>
                    <td>{{ stat.total_stamps }}</td>
                    <td>{{ stat.first_stamp.strftime('%H:%M') if stat.first_stamp else '-' }}</td>
                    <td>{{ stat.last_stamp.strftime('%H:%M') if stat.last_stamp else '-' }}</td>
                    <td>
                        {% if stat.first_stamp and stat.last_stamp %}
                            {% set minutes = ((stat.last_stamp - stat.first_stamp).total_seconds() / 60)|round|int %}
                            {% if minutes < 60 %}
                                {{ minutes }}分
                            {% else %}
                                {{ (minutes / 60)|round|int }}時間{{ minutes % 60 }}分
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
     
        <div class="pagination">
            {% if users_pagination.has_prev %}
                <a href="{{ url_for('stamp_statistics', 
                                   page=users_pagination.prev_num,
                                   search=search_query,
                                   stats_filter=stats_filter,
                                   sort_order=sort_order) }}" 
                   class="pagination-link">« 前へ</a>
            {% endif %}
        
            {% for page_num in users_pagination.iter_pages() %}
                {% if page_num %}
                    <a href="{{ url_for('stamp_statistics',
                                       page=page_num,
                                       search=search_query,
                                       stats_filter=stats_filter,
                                       sort_order=sort_order) }}"
                       class="pagination-link {% if page_num == users_pagination.page %}active{% endif %}">
                        {{ page_num }}
                    </a>
                {% endif %}
            {% endfor %}
        
            {% if users_pagination.has_next %}
                <a href="{{ url_for('stamp_statistics',
                                   page=users_pagination.next_num,
                                   search=search_query,
                                   stats_filter=stats_filter,
                                   sort_order=sort_order) }}"
                   class="pagination-link">次へ »</a>
            {% endif %}
        </div>
     </div>

        <!-- 進行状況マップ -->
        <!-- templates/admin/statistics.html の進行状況マップ部分 -->
        <div class="stats-section" data-auto-reload="true">
            <h2>スポット進行状況マップ</h2>
            
            <div class="filter-section">
                <form action="{{ url_for('stamp_statistics') }}" method="get">
                    <input type="text" name="search" placeholder="ユーザー検索" value="{{ search_query }}">
                    <input type="hidden" name="stats_filter" value="{{ stats_filter }}">
                    <input type="hidden" name="sort_order" value="{{ sort_order }}">
                    <button type="submit" class="filter-button">フィルター</button>
                </form>
            </div>
        </div>
        
        {% if progress_map_data and progress_map_data.total_pages > 1 %}
        <div class="pagination">
            {% if progress_map_data.current_page > 1 %}
                <a href="{{ url_for('stamp_statistics', page=progress_map_data.current_page-1, search=search_query, stats_filter=stats_filter, sort_order=sort_order) }}" class="pagination-link">« 前へ</a>
            {% endif %}
        
            {% for p in range(1, progress_map_data.total_pages + 1) %}
                <a href="{{ url_for('stamp_statistics', page=p, search=search_query, stats_filter=stats_filter, sort_order=sort_order) }}" class="pagination-link {% if p == progress_map_data.current_page %}active{% endif %}">
                    {{ p }}
                </a>
            {% endfor %}
        
            {% if progress_map_data.current_page < progress_map_data.total_pages %}
                <a href="{{ url_for('stamp_statistics', page=progress_map_data.current_page+1, search=search_query, stats_filter=stats_filter, sort_order=sort_order) }}" class="pagination-link">次へ »</a>
            {% endif %}
        </div>
        {% endif %}

        <div class="map-container">
            <div class="y-axis">
                {% set num_labels = progress_map_data.checkpoint_names|length %}
                {% for i in range(num_labels) %}
                    {% set y_pos = i / (num_labels - 1) * 80 %}
                    <div class="y-label" style="top: {{ y_pos }}%;">{{ progress_map_data.checkpoint_names[i] }}</div>
                {% endfor %}
            </div>
            
            <div class="plot-container">
                {% if progress_map_data.progress_data %}
                    {% set user_data = {} %}
                    {% for user in progress_map_data.user_order %}
                        {% set user_data = user_data.update({user: []}) or user_data %}
                    {% endfor %}
                    
                    {% for point in progress_map_data.progress_data %}
                        {% if point.x in user_data %}
                            {% set _ = user_data[point.x].append(point) %}
                        {% endif %}
                    {% endfor %}
            
                    {% set total_users = user_data|length %}
                    {% set x_spacing = 100 if total_users <= 1 else (100 / (total_users - 1)) %}
                
                    {% for user in progress_map_data.user_order %}
                        {% set x_pos = loop.index0 * x_spacing %}
                        {% for point in user_data[user] %}
                            {% set y_pos = progress_map_data.checkpoint_names.index(point.y) / (num_labels - 1) * 100 %}
                            <div class="data-point" style="left: {{ x_pos }}%; top: {{ y_pos }}%;" data-user="{{ point.x }}" data-checkpoint="{{ point.y }}" data-time="{{ point.timestamp }}"></div>
                        {% endfor %}
                    {% endfor %}
                    
                    <div class="x-axis">
                        {% for user in progress_map_data.user_order %}
                            {% set x_pos = loop.index0 * x_spacing %}
                            <div class="x-label" style="left: {{ x_pos }}%;">{{ user }}</div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data-message">表示するデータがありません</div>
                {% endif %}
            </div>
        </div>
            


            <style>

            .search-form {
            display: none;
            }

            /* フィルターセクションのスタイル調整 */
            .filter-section {
            margin: 20px 0;
            }

            .filter-section select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
            }

            .filter-section button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            }

            .filter-section button:hover {
            background-color: #45a049;
            }

            .search-bar {
                margin-bottom: 20px;
            }

            .search-bar form {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .search-bar input,
            .search-bar select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .search-bar select {
                min-width: 150px;
            }

            .search-bar button {
                padding: 8px 16px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .pagination-ellipsis {
                padding: 6px 12px;
                color: #666;
            }

            .search-bar button:hover {
                background: #0056b3;
            }

            .progress-map {
                display: flex;
                margin: 40px 20px;
                padding-bottom: 60px;
            }
            
            .map-container {
                display: flex;
                padding-left: 120px;
                position: relative;
            }
            
            .grid-background {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            .grid-line {
                height: 1px;
                background-color: #f0f0f0;
            }
            
            .plot-container {
                flex: 1;
                min-height: 500px;
                position: relative;
                margin-bottom: 60px;
            }
            
            .no-data-message {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #666;
                font-style: italic;
            }
            
            .data-point {
                position: absolute;
                width: 12px;
                height: 12px;
                background-color: #007bff;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 2;
            }
            
            .data-point:hover {
                width: 16px;
                height: 16px;
                background-color: #0056b3;
                box-shadow: 0 0 8px rgba(0,123,255,0.5);
                z-index: 3;
            }
            
            .y-axis {
                position: absolute;
                top: 0;
                left: 0;
                height: 93%;
                width: 120px;
                padding-right: 20px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            .y-label {
                text-align: right;
                padding: 5px;
                font-size: 12px;
                height: 20px;
            }
            
            /* ラベルのコンテナのスタイルも調整 */
            .x-axis {
                position: absolute;
                bottom: -60px;  /* より多くのスペースを確保 */
                left: 0;
                right: 0;
                height: 50px;  /* 高さを増やす */
            }
            
            .x-label {
                position: absolute;
                transform: translateX(-50%) translateY(100%);
                text-align: center;
                font-size: 12px;
                padding-top: 5px;
            }

            .pagination-controls {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                margin-top: 20px;
                padding: 10px;
            }

            .pagination-button {
                padding: 6px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                color: #333;
                text-decoration: none;
                transition: background-color 0.2s;
            }

            .pagination-button:hover {
                background-color: #f0f0f0;
            }

            .pagination-current {
                padding: 6px 12px;
                background-color: #007bff;
                color: white;
                border-radius: 4px;
                font-weight: bold;
            }

            .pagination-button.prev,
            .pagination-button.next {
                font-weight: bold;
            }

            .pagination-button.disabled {
                color: #999;
                pointer-events: none;
                background-color: #f5f5f5;
            }
            
            .stamp-info {
            margin-top: 20px;
            }

            .stamp-info > h2 {
            margin-bottom: 10px;
            }

            .stamp-list,
            .user-stats,
            .checkpoint-stats {
            margin-top: 20px;
            }

            @media (max-width: 768px) {
                .progress-map {
                    margin: 20px 10px;
                }
            
                .y-axis {
                    width: 80px;
                }
            
                .y-label {
                    font-size: 10px;
                }
            
                .map-container {
                    height: 400px;
                    margin-bottom: 60px;
                }
            
                .x-label {
                    font-size: 10px;
                    letter-spacing: 1px;
                }
                
                .x-axis {
                    bottom: -50px;
                }
                
                /* ツールチップのスタイルも調整 */
                .tooltip {
                    position: absolute;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1001;
                    white-space: pre-line;
                }

            }
            </style>
            
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const points = document.querySelectorAll('.data-point');
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            
                points.forEach(point => {
                    point.addEventListener('mouseover', function(e) {
                        const tooltipContent = `
                            ユーザー: ${point.dataset.user}
                            チェックポイント: ${point.dataset.checkpoint}
                            時刻: ${point.dataset.time}
                        `.trim();
            
                        tooltip.textContent = tooltipContent;
                        tooltip.style.display = 'block';
            
                        const rect = point.getBoundingClientRect();
                        tooltip.style.left = `${rect.left + window.scrollX}px`;
                        tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 10}px`;
                    });
            
                    point.addEventListener('mouseout', function() {
                        tooltip.style.display = 'none';
                    });
                });
            });
            </script>

        <!-- チェックポイント別統計 -->
        <div class="stats-section">
            <h2>チェックポイント別取得状況</h2>
            <div class="chart-container">
                <canvas id="checkpointChart"></canvas>
            </div>
            <table>
                <tr>
                    <th>チェックポイント名</th>
                    <th>タイプ</th>
                    <th>訪問回数</th>
                </tr>
                {% for stat in checkpoint_stats %}
                <tr>
                    <td>{{ stat.name }}</td>
                    <td>{{ stat.checkpoint_type }}</td>
                    <td>{{ stat.visit_count }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <!-- 時間帯別統計 -->
        <div class="stats-section">
            <h2>時間帯別取得状況</h2>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // チェックポイントグラフ
        new Chart(document.getElementById('checkpointChart'), {
            type: 'bar',
            data: {
                labels: {{ checkpoint_stats | map(attribute='name') | list | tojson }},
                datasets: [{
                    label: '訪問回数',
                    data: {{ checkpoint_stats | map(attribute='visit_count') | list | tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]  // ユニーク訪問者数のデータセットを削除
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: 100  // または適切な最大値を設定
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'チェックポイント別訪問回数'
                    }
                }
            }
        });

        // 時間帯別グラフ
        new Chart(document.getElementById('hourlyChart'), {
            type: 'line',
            data: {
                labels: Object.keys({{ hours_data | tojson }}),
                datasets: [{
                    label: 'スタンプ取得数',
                    data: Object.values({{ hours_data | tojson }}).map(d => d.stamps),
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1
                }, {
                    label: 'ユニークユーザー数',
                    data: Object.values({{ hours_data | tojson }}).map(d => d.users),
                    fill: false,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <script>
        let autoReloadEnabled = true;
        const RELOAD_INTERVAL = 30;
        let countdown = RELOAD_INTERVAL;
        let isInputting = false;
        let pausedCountdown = null;

        function setupInputTracking() {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    isInputting = true;
                    pausedCountdown = countdown;
                    updateReloadStatus();
                });

                input.addEventListener('blur', () => {
                    isInputting = false;
                    if (autoReloadEnabled) {
                        countdown = pausedCountdown;
                    }
                    updateReloadStatus();
                });
            });
        }

        function updateReloadStatus() {
            const statusElement = document.getElementById('reload-status');
            const toggleButton = document.getElementById('reload-toggle');
            const forceButton = document.querySelector('.force-button'); // 今すぐ更新ボタン

            if (isInputting) {
                statusElement.classList.add('paused');
                toggleButton.textContent = '入力中';
                toggleButton.disabled = true;
                toggleButton.classList.remove('start-update');
                forceButton.disabled = true; // 今すぐ更新ボタンを無効化
            } else {
                statusElement.classList.remove('paused');
                toggleButton.disabled = false;
                forceButton.disabled = false; // 今すぐ更新ボタンを有効化

                if (autoReloadEnabled) {
                    toggleButton.textContent = '自動更新を停止';
                    toggleButton.classList.remove('start-update');
                } else {
                    toggleButton.textContent = '自動更新を開始';
                    toggleButton.classList.add('start-update');
                }
            }
        }

        function updateCountdown() {
            const countdownElement = document.getElementById('countdown');
            if (!isInputting && autoReloadEnabled) {
                countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    reloadContent();
                    autoSubmitSearchForms(); // 各検索フォームを自動送信
                    countdown = RELOAD_INTERVAL;
                }
                countdown--;
            }
        }

        async function reloadContent() {
            if (isInputting) return;

            try {
                const url = new URL(window.location.href);
                url.searchParams.set('filter', 'has_stamps');
                // 現在のページ番号を維持
                const currentPage = url.searchParams.get('page') || '1';
                url.searchParams.set('page', currentPage);
                
                const response = await fetch(url.toString());
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');

                // 進行状況マップの更新
                const newProgressMap = doc.querySelector('.progress-map');
                const currentProgressMap = document.querySelector('.progress-map');
                if (newProgressMap && currentProgressMap) {
                    currentProgressMap.innerHTML = newProgressMap.innerHTML;
                }

                // ページネーションの更新
                const newPagination = doc.querySelector('.pagination-controls');
                const currentPagination = document.querySelector('.pagination-controls');
                if (newPagination && currentPagination) {
                    currentPagination.innerHTML = newPagination.innerHTML;
                }

                // Y軸ラベルの更新
                const newYAxis = doc.querySelector('.y-axis');
                const currentYAxis = document.querySelector('.y-axis');
                if (newYAxis && currentYAxis) {
                    currentYAxis.innerHTML = newYAxis.innerHTML;
                }

                // X軸ラベルの更新
                const newXAxis = doc.querySelector('.x-axis');
                const currentXAxis = document.querySelector('.x-axis');
                if (newXAxis && currentXAxis) {
                    currentXAxis.innerHTML = newXAxis.innerHTML;
                }

                // その他の統計情報の更新
                ['login-table', 'checkpoint-table', 'survey-table', 'quiz-table'].forEach(tableId => {
                    const newTable = doc.getElementById(tableId);
                    const currentTable = document.getElementById(tableId);
                    if (newTable && currentTable) {
                        currentTable.innerHTML = newTable.innerHTML;
                    }
                });

                setupInputTracking();
            } catch (error) {
                console.error('Error reloading content:', error);
            }
        }

        async function autoSubmitSearchForms() {
            try {
                // 進行状況マップ用のフィルター適用
                const url = new URL(window.location.href);
                url.searchParams.set('filter', 'has_stamps');
                await fetch(url.toString());
                
                // 既存の処理
                const userSearchForm = document.querySelector('.search-form form');
                if (userSearchForm) {
                    await reloadUserStats();
                    updateCharts();
                    userSearchForm.submit();
                }

                // チェックポイント統計とその他の更新処理
                await reloadCheckpointStats();
                await reloadHourlyStats();
                updateCharts();
            } catch (error) {
                console.error('Error in autoSubmitSearchForms:', error);
            }
        }

        async function reloadUserStats() {
            try {
                const response = await fetch(`/{{ admin_hash }}/statistics?${new URLSearchParams(new FormData(userSearchForm))}`);
                const data = await response.json();
                updateUserStatsTable(data.users_pagination.items);
            } catch (error) {
                console.error('Error reloading user stats:', error);
            }
        }

        function updateUserStatsTable(data) {
            const tableBody = document.querySelector('.stats-section:nth-of-type(2) tbody');
            tableBody.innerHTML = '';

            for (const stat of data) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.account}</td>
                    <td>${stat.total_stamps}</td>
                    <td>${stat.first_stamp ? stat.first_stamp.strftime('%H:%M') : '-'}</td>
                    <td>${stat.last_stamp ? stat.last_stamp.strftime('%H:%M') : '-'}</td>
                    <td>${getTimeElapsed(stat.first_stamp, stat.last_stamp)}</td>
                `;
                tableBody.appendChild(row);
            }
        }

        function getTimeElapsed(start, end) {
            if (!start || !end) {
                return '-';
            }
            const minutes = Math.round((end - start).total_seconds() / 60);
            if (minutes < 60) {
                return `${minutes}分`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return `${hours}時間${remainingMinutes}分`;
            }
        }

        async function reloadCheckpointStats() {
            try {
                const response = await fetch(`/{{ admin_hash }}/statistics?${new URLSearchParams(new FormData(checkpointStatsForm))}`);
                const data = await response.json();
                updateCheckpointStatsTable(data.checkpoint_stats);
            } catch (error) {
                console.error('Error reloading checkpoint stats:', error);
            }
        }

        function updateCheckpointStatsTable(data) {
            const tableBody = document.querySelector('.stats-section:nth-of-type(3) tbody');
            tableBody.innerHTML = '';

            for (const stat of data) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.name}</td>
                    <td>${stat.checkpoint_type}</td>
                    <td>${stat.visit_count}</td>
                `;
                tableBody.appendChild(row);
            }

            updateCheckpointChart();
        }

        function updateCheckpointChart() {
            const chartData = {
                labels: {{ checkpoint_stats | map(attribute='name') | list | tojson }},
                datasets: [{
                    label: '訪問回数',
                    data: {{ checkpoint_stats | map(attribute='visit_count') | list | tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };

            const checkpointChart = Chart.getChart('checkpointChart') || new Chart(document.getElementById('checkpointChart'), {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'チェックポイント別訪問回数'
                        }
                    }
                }
            });

            checkpointChart.data = chartData;
            checkpointChart.update();
        }

        async function reloadHourlyStats() {
            try {
                const response = await fetch(`/{{ admin_hash }}/statistics`);
                const data = await response.json();
                updateHourlyChart(data.hours_data);
            } catch (error) {
                console.error('Error reloading hourly stats:', error);
            }
        }

        function updateHourlyChart(data) {
            const hourlyChart = Chart.getChart('hourlyChart') || new Chart(document.getElementById('hourlyChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'スタンプ取得数',
                        data: Object.values(data).map(d => d.stamps),
                        fill: false,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1
                    }, {
                        label: 'ユニークユーザー数',
                        data: Object.values(data).map(d => d.users),
                        fill: false,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            hourlyChart.data.labels = Object.keys(data);
            hourlyChart.data.datasets[0].data = Object.values(data).map(d => d.stamps);
            hourlyChart.data.datasets[1].data = Object.values(data).map(d => d.users);
            hourlyChart.update();
        }

        function updateCharts() {
            updateCheckpointChart();
            updateHourlyChart({{ hours_data | tojson }});
        }

        // 自動更新の切り替え
        document.getElementById('reload-toggle').addEventListener('click', function() {
            if (!isInputting) {
                autoReloadEnabled = !autoReloadEnabled;
                if (!autoReloadEnabled) {
                    pausedCountdown = countdown;
                } else {
                    countdown = pausedCountdown || RELOAD_INTERVAL;
                }
                updateReloadStatus();
            }
        });

        function forceReload() {
            if (!isInputting) {
                countdown = 0;
                autoReloadEnabled = true;
                updateCountdown();
                updateReloadStatus();
            }
        }

        setInterval(() => {
            updateCountdown();
        }, 1000);

        document.addEventListener('DOMContentLoaded', () => {
            setupInputTracking();
            updateCountdown();
            updateReloadStatus();
        });

        // statistics.htmlに追加するJavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // 現在のフィルター状態を保存
            const currentFilter = new URLSearchParams(window.location.search);
            const statsFilter = currentFilter.get('stats_filter') || 'has_stamps';
            const sortOrder = currentFilter.get('sort_order') || 'latest_first';
            
            // 自動更新用の関数
            function autoReload() {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('stats_filter', statsFilter);
                currentUrl.searchParams.set('sort_order', sortOrder);
                window.location.href = currentUrl.toString();
            }

            // カウントダウンタイマーの設定
            let timeLeft = 30;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                timeLeft--;
                if (countdownElement) {
                    countdownElement.textContent = timeLeft;
                }
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    autoReload();
                }
            }, 1000);

            // 自動更新停止ボタンの処理
            const stopButton = document.querySelector('.update-controls button:first-child');
            if (stopButton) {
                stopButton.addEventListener('click', () => {
                    clearInterval(countdownInterval);
                    if (countdownElement) {
                        countdownElement.parentElement.style.display = 'none';
                    }
                });
            }

            // 今すぐ更新ボタンの処理
            const updateButton = document.querySelector('.update-controls button:last-child');
            if (updateButton) {
                updateButton.addEventListener('click', () => {
                    clearInterval(countdownInterval);
                    autoReload();
                });
            }
        });

                // フィルター状態の永続化
        document.addEventListener('DOMContentLoaded', function() {
            // フィルター状態の取得関数
            function getCurrentFilters() {
                const urlParams = new URLSearchParams(window.location.search);
                return {
                    stats_filter: urlParams.get('stats_filter') || 'has_stamps',
                    sort_order: urlParams.get('sort_order') || 'latest_first',
                    page: urlParams.get('page') || '1',
                    search: urlParams.get('search') || ''
                };
            }

            // 現在のフィルター状態を保存
            const filters = getCurrentFilters();

            // リロード時のURLを構築する関数
            function buildReloadUrl() {
                const currentUrl = new URL(window.location.href);
                Object.entries(filters).forEach(([key, value]) => {
                    if (value) {
                        currentUrl.searchParams.set(key, value);
                    }
                });
                return currentUrl.toString();
            }

            // 既存の自動更新処理を修正
            function autoReload() {
                window.location.href = buildReloadUrl();
            }

            // 自動更新インターバルの設定
            const reloadInterval = setInterval(() => {
                if (autoReloadEnabled && !isInputting) {
                    autoReload();
                }
            }, 30000);

            // 今すぐ更新ボタンのイベントハンドラを修正
            document.querySelector('.force-button-container').addEventListener('click', function() {
                if (!isInputting) {
                    autoReload();
                }
            });
        });
    </script>

    <style>
        /* リロードステータスのスタイル更新 */
        #reload-status {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 15px 30px;
            background-color: rgba(248, 249, 250, 0.98);
            border: 2px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 500px; /* 最小幅を設定 */
        }
        
        .force-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .reload-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 200px auto 340px; /* 3列のグリッドを調整 */
            gap: 20px;
            align-items: center;
        }

        .navigation-button {
            justify-self: start;
        }

        .nav-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .nav-button:hover {
            background-color: #45a049;
        }

        .update-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            min-width: 340px; /* ボタンが重ならないように最小幅を設定 */
        }

        /* レスポンシブ対応のメディアクエリを更新 */
        @media (max-width: 768px) {
            .reload-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .navigation-button, .countdown-display, .update-controls {
                justify-self: center;
            }

            .update-controls {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
        }

        .countdown-display {
            font-size: 1.1em;
            white-space: nowrap;
        }
        
        #countdown {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.3em;
            margin: 0 5px;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
        }
        
        /* 通常の停止ボタン */
        .control-button {
            padding: 8px 16px;
            font-size: 0.9em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #ff4444;
            color: white;
            min-width: 140px; /* 最小幅を設定 */
        }
        
        /* 開始ボタンの特別なスタイル */
        .control-button.start-update {
            background-color: #4CAF50;
            color: white;
            font-size: 1.1em;
            padding: 12px 24px;
            font-weight: bold;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: attention-pulse 2s infinite;
            z-index: 2; /* 他の要素より前面に */
            min-width: 160px; /* 大きくなった時の最小幅 */
        }
        
        /* 開始ボタンのホバー効果 */
        .control-button.start-update:hover {
            background-color: #45a049;
            transform: scale(1.15);
        }
        
        .force-button-container {
            display: flex;
            justify-content: flex-start;
        }
        
        .force-button {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .force-button:hover {
            background-color: #1976D2;
        }
        
        /* パルスアニメーション */
        @keyframes attention-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        #reload-status.paused {
            background-color: rgba(255, 224, 224, 0.98);
        }
        
        #reload-status button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            animation: none;
            box-shadow: none;
        }
        
        /* ボタンの配置が崩れないようにするためのメディアクエリ */
        @media (max-width: 768px) {
            .reload-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            #reload-status {
                min-width: auto;
                width: 95%;
            }
        }
    </style>

</body>
</html>