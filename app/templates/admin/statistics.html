<!-- templates/admin/statistics.html -->
<!DOCTYPE html>
<html>
<head>
    <title>スタンプラリー統計情報</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-section {
            margin-bottom: 40px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .total-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
        }
        .back-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="stats-container">
        <a href="/{{ admin_hash }}" class="back-button">管理画面に戻る</a>
        <h1>スタンプラリー統計情報</h1>

        <!-- 全体の統計 -->
        <div class="total-stats">
            <div class="stat-card">
                <div class="stat-label">総スタンプ取得数</div>
                <div class="stat-number">{{ total_stats.total_stamps }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">参加者数</div>
                <div class="stat-number">{{ total_stats.total_users }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">完走者数</div>
                <div class="stat-number">{{ total_stats.completion_count }}</div>
            </div>
        </div>

    <!-- templates/admin/statistics.html の関連部分を更新 -->
    <!-- ユーザー検索フォーム -->
    <div class="search-form">
        <form method="GET" action="/{{ admin_hash }}/statistics">
            <input type="text" 
                name="search" 
                value="{{ search_query }}" 
                placeholder="ユーザー名で検索..."
                class="search-input">
            <button type="submit" class="search-button">検索</button>
        </form>
    </div>

    <!-- ユーザー別取得状況 -->
    <div class="stats-section">
        <h2>ユーザー別取得状況</h2>
        <table>
            <tr>
                <th>アカウント</th>
                <th>取得スタンプ数</th>
                <th>開始時刻</th>
                <th>最終取得時刻</th>
                <th>所要時間</th>
            </tr>
            {% for stat in users_pagination.items %}
            <tr>
                <td>{{ stat.account }}</td>
                <td>{{ stat.total_stamps }}</td>
                <td>{{ stat.first_stamp.strftime('%H:%M') if stat.first_stamp else '-' }}</td>
                <td>{{ stat.last_stamp.strftime('%H:%M') if stat.last_stamp else '-' }}</td>
                <td>
                    {% if stat.first_stamp and stat.last_stamp %}
                        {% set minutes = ((stat.last_stamp - stat.first_stamp).total_seconds() / 60)|round|int %}
                        {% if minutes < 60 %}
                            {{ minutes }}分
                        {% else %}
                            {{ (minutes / 60)|round|int }}時間{{ minutes % 60 }}分
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- ページネーション -->
        <div class="pagination">
            {% if users_pagination.has_prev %}
                <a href="{{ url_for('stamp_statistics', page=users_pagination.prev_num, search=search_query) }}">&laquo; 前へ</a>
            {% endif %}

            {% for page_num in users_pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num == users_pagination.page %}
                        <span class="current-page">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ url_for('stamp_statistics', page=page_num, search=search_query) }}">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                    <span class="ellipsis">...</span>
                {% endif %}
            {% endfor %}

            {% if users_pagination.has_next %}
                <a href="{{ url_for('stamp_statistics', page=users_pagination.next_num, search=search_query) }}">次へ &raquo;</a>
            {% endif %}
        </div>
    </div>

        <!-- 進行状況マップ -->
        <!-- templates/admin/statistics.html の進行状況マップ部分 -->
    <div class="stats-section">
        <h2>スポット進行状況マップ</h2>
        <div class="progress-map-container">
            <canvas id="progressMap"></canvas>
        </div>
        
        <!-- ページネーション -->
        <div class="pagination">
            {% for page in range(1, progress_map_data.total_pages + 1) %}
                <a href="{{ url_for('stamp_statistics', page=page, search=search_query) }}" 
                class="{% if page == current_page %}active{% endif %}">
                    {{ page }}
                </a>
            {% endfor %}
        </div>
    </div>

    <script>
    const progressMap = new Chart(document.getElementById('progressMap'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'スタンプ取得',
                data: {{ progress_map_data.progress_data | tojson }},
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                pointRadius: 8,
                pointHoverRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'category',
                    labels: {{ progress_map_data.checkpoint_names | tojson }},
                    title: {
                        display: true,
                        text: 'チェックポイント'
                    }
                },
                x: {
                    type: 'category',
                    title: {
                        display: true,
                        text: 'ユーザー'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const data = context.raw;
                            return `${data.x}: ${data.y} (${data.timestamp})`;
                        }
                    }
                },
                legend: {
                    display: false
                }
            }
        }
    });
    </script>

    <style>
    .progress-map-container {
        height: 500px;
        margin: 20px 0;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .pagination a {
        padding: 5px 10px;
        border: 1px solid #ddd;
        text-decoration: none;
        color: #333;
    }

    .pagination a.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    </style>
    </script>

        <!-- チェックポイント別統計 -->
        <div class="stats-section">
            <h2>チェックポイント別取得状況</h2>
            <div class="chart-container">
                <canvas id="checkpointChart"></canvas>
            </div>
            <table>
                <tr>
                    <th>チェックポイント名</th>
                    <th>タイプ</th>
                    <th>訪問回数</th>
                </tr>
                {% for stat in checkpoint_stats %}
                <tr>
                    <td>{{ stat.name }}</td>
                    <td>{{ stat.checkpoint_type }}</td>
                    <td>{{ stat.visit_count }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <!-- 時間帯別統計 -->
        <div class="stats-section">
            <h2>時間帯別取得状況</h2>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // チェックポイントグラフ
        new Chart(document.getElementById('checkpointChart'), {
            type: 'bar',
            data: {
                labels: {{ checkpoint_stats | map(attribute='name') | list | tojson }},
                datasets: [{
                    label: '訪問回数',
                    data: {{ checkpoint_stats | map(attribute='visit_count') | list | tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]  // ユニーク訪問者数のデータセットを削除
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: 100  // または適切な最大値を設定
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'チェックポイント別訪問回数'
                    }
                }
            }
        });

        // 時間帯別グラフ
        new Chart(document.getElementById('hourlyChart'), {
            type: 'line',
            data: {
                labels: Object.keys({{ hours_data | tojson }}),
                datasets: [{
                    label: 'スタンプ取得数',
                    data: Object.values({{ hours_data | tojson }}).map(d => d.stamps),
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1
                }, {
                    label: 'ユニークユーザー数',
                    data: Object.values({{ hours_data | tojson }}).map(d => d.users),
                    fill: false,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>
</html>